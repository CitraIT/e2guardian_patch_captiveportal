--- /usr/local/captiveportal/index.php.original  2022-01-31 16:53:42.000000000 -0300
+++ /usr/local/captiveportal/index.php   2022-09-01 22:01:09.736907000 -0300
@@ -38,6 +38,7 @@
 global $cpzone, $cpzoneid;

 $cpzone = strtolower($_REQUEST['zone']);
+if(empty($cpzone)){ $cpzone = "lan"; }
 $cpcfg = $config['captiveportal'][$cpzone];

 /* NOTE: IE 8/9 is buggy and that is why this is needed */
@@ -266,6 +267,70 @@
                 captiveportal_logportalauth($user, $clientmac, $clientip, $auth_result['login_status']);
                 portal_allow($clientip, $clientmac, $user, $passwd, $redirurl, $auth_result['attributes'], $pipeno, $auth_result['auth_method'], $context);

+                /* citra it modifications */
+                //$target_user = "luciano"; # user builtin $user
+
+                /* READING LIST OF USER AND GROUP_ID ASSOCIATION */
+                $grouplist_content = file_get_contents("/usr/local/etc/e2guardian/lists/filtergroupslist");
+                $lines = explode("\n", $grouplist_content);
+                $user_group_id = 0;
+
+                // searching for user record in filtergrouplist
+                for($i=0; $i<=count($lines); $i++) {
+                    if(!empty($lines[$i])) {
+                        $user_group_array = explode("=", $lines[$i]);
+                        if($user_group_array[0] == $user) {
+                            // we found target user
+                            $user_group_id = str_replace("filter", "",  $user_group_array[1]);
+                        }
+                    }
+                }
+
+
+
+                // TODO read basedomain var from e2guardian dnsauth pluginauth config
+                $dnsauthplugin_content = file_get_contents("/usr/local/etc/e2guardian/authplugins/dnsauth.conf");
+                $dnsauthplugin_lines = explode("\n", $dnsauthplugin_content);
+                $dnsauthplugin_lines_count = count($dnsauthplugin_lines);
+                $basedomain = "home.arpa";
+                for($i=0; $i<=$dnsauthplugin_lines_count; $i++) {
+                        $re_result = preg_match('/basedomain = "(.*)"/', $dnsauthplugin_lines[$i], $matches);
+                        if($re_result) {
+                                $basedomain = $matches[1];
+                        }
+                }
+
+
+                // convert user ip to dnsauth txt format
+                $dnsip = str_replace(".", "-", $clientip);
+                //$user_txt_dns_record = "local-data: '$dnsip.$basedomain TXT \"$user,$user_group_id\"'\n";
+                $user_txt_dns_record = "local-data: '$dnsip.$basedomain TXT \"$user,$user_group_id\"'";
+
+                // search if user already registered on dns
+                $dnsauth_content = file_get_contents("/var/unbound/dnsauth.conf");
+                $dnsauth_lines = explode("\n", $dnsauth_content);
+                $dnsauth_lines_count = count($dnsauth_lines);
+                $user_record_found = false;
+                for($i=0; $i<=$dnsauth_lines_count; $i++) {
+                        //echo "searching on line " . $dnsauth_lines[$i] . "\n";
+                        if($dnsauth_lines[$i] == $user_txt_dns_record){
+                                $user_record_found = true;
+                        }
+                }
+
+
+                // open dnsauth file and write the record
+                // what if user authenticated with another IP previously?
+                if(!$user_record_found) {
+                        $dnsauthfile = fopen("/var/unbound/dnsauth.conf", "a");
+                        fwrite($dnsauthfile, $user_txt_dns_record . "\n");
+                        fclose($dnsauthfile);
+
+                        // signalling unbound to reload with SIGHUP
+                        $unbound_pid = @system("ps -xa | grep unbound | grep -v grep | awk '{print $1}'");
+                        @system("kill -s HUP " . $unbound_pid);
+                }
+
         } else {
                 captiveportal_free_dn_ruleno($pipeno);
                 $type = "error";
@@ -298,3 +363,4 @@
 ob_flush();

 ?>
+
